<!-- <div class="grid container"> -->
<div style="width: 300px;display: inline-block;padding-left: 10px;">
    <h2>Current Leave Balance: <span [ngClass]="{'negative-balance':currentBalance<0,'positive-balance':currentBalance>=0}">{{currentBalance}}</span></h2>
</div>
<div style="justify-self: end;display: inline-block;">
    <app-button size='small' theme="blue-lite" type="button" w="130" (click)="openApplyPopUp()">Apply</app-button>
</div>
<!-- </div> -->
<div class="bg-box">
    <h2 style="color: var(--color-primary);">Leave Requests <span *ngIf="appliedCount !=0">[ {{appliedCount}} ]</span>
    </h2>

    <div class="grid">
        <div *ngIf="LEAVE_APPLICATION_DATA.length==0">
            No leave requests available
        </div>

        <div style="overflow-y: auto;max-height: 250px;">
            <table mat-table [dataSource]="LEAVE_APPLICATION_DATA" *ngIf="LEAVE_APPLICATION_DATA.length!=0" class="mat-elevation-z8">

                <ng-container matColumnDef="serial">
                    <th mat-header-cell *matHeaderCellDef style="width: 80px;"> S.No. </th>
                    <td mat-cell *matCellDef="let element;let i=index;">{{i+1}} </td>
                </ng-container>

                <ng-container matColumnDef="day_count">
                    <th mat-header-cell *matHeaderCellDef>Total Days </th>
                    <td mat-cell *matCellDef="let element"> {{element.day_count}} </td>
                </ng-container>

                <ng-container matColumnDef="startdate">
                    <th mat-header-cell *matHeaderCellDef> Start Date </th>
                    <td mat-cell *matCellDef="let element"> {{convertDatefmt(element.startdate)}} </td>
                </ng-container>

                <ng-container matColumnDef="enddate">
                    <th mat-header-cell *matHeaderCellDef> End Date </th>
                    <td mat-cell *matCellDef="let element"> {{convertDatefmt(element.enddate)}} </td>
                </ng-container>

                <ng-container matColumnDef="leave_type">
                    <th mat-header-cell *matHeaderCellDef>Type</th>
                    <td mat-cell *matCellDef="let element">
                        {{element.leave_type_name == 'Paid' ? 'General' : element.leave_type_name}} </td>
                </ng-container>

                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Leave Status</th>
                    <td mat-cell *matCellDef="let element"> {{element.req_status}} </td>
                </ng-container>

                <ng-container matColumnDef="view">
                    <th mat-header-cell *matHeaderCellDef> Action</th>
                    <td mat-cell *matCellDef="let element;let i = index">
                        <div class="flex middle-xs start-xs">
                            <app-button theme="blue-lite" size="extra-small" title="View Details" type="button" style="border: none;background-color:transparent;" (click)="leaveDetailsRequestId = {request_id: element.id};showAppliedLeaveDialog.open()" class="mr-5">
                                View
                            </app-button>
                            <app-button theme="danger" size="extra-small" *ngIf="element.status != leaveApplcnStatus.Rejected && element.status != leaveApplcnStatus.EmployeeCancelled && !(element.status == leaveApplcnStatus.Approved && element.isInProgress)" type="button" style="border: none;background-color:transparent;"
                                (click)="onClickCancelLeaveApplication($event,element)">
                                Cancel
                            </app-button>
                        </div>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="appliedLeaveColumns sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: appliedLeaveColumns; "></tr>
            </table>
        </div>
    </div>
</div>

<div class="bg-box mt-20">
    <h2 style="color: var(--color-primary);">Leave History <span *ngIf="historyCount != 0">[ {{historyCount}}
      ]</span></h2>
    <div class="flex middle-xs">
        <div style="display: inline-block;">
            <div class="dateinput">
                <input type="daterange" placeholder="Select Date Range" ngxDaterangepickerMd startKey="startDate" endKey="endDate" [alwaysShowCalendars]="true" [(ngModel)]="selectedHistoryRange" [showRangeLabelOnInput]="true" [locale]="{separator: ' To ',format: 'DD-MM-YYYY'}"
                    #picker [ranges]="ranges" [keepCalendarOpeningWithRange]="true" class="ngx-daterangepicker-action" style="border: none;background: none;color: #3a7bca;" [opens]="'right'" [drops]="'up'" readonly
                    (datesUpdated)="getLeaveHistory($event)" />

                <button type="button" class="ngx-daterangepicker-action" style="background: none; border: none;cursor: pointer;">
          <mat-icon role="img" (click)="pickerDirective.open()"
            class="mat-icon material-icons ngx-daterangepicker-action" style="color: #3a7bca;">date_range</mat-icon>
        </button>
            </div>
        </div>
        <div class="export_icon ml-15" style="margin-top:15px;" >
            <a  (click)="onClickExportResolved()" style="max-height: 10px;">
                  <span class="ml-5" [svgIcon]="{url:'./assets/icons-sprite.svg#download-new',w:30}" style="color:var(--color-tertiary);margin-top:0px;cursor:pointer" svg-fill="currentColor"></span>
                <!-- <span class="ml-5" [svgIcon]="{url:'./assets/icons-sprite.svg#download',w:15}"></span> -->
                <!-- <span> <img width="40px" height="40px" src="assets/images/exportExcel.png" alt=""></span> -->
                <!-- </p> -->
            </a>
        </div>
        <!-- <app-button class="ml-20" (click)="pickerDirective.clear()" size='small' type="submit">Reset
    </app-button> -->
    </div>
    <div class="mt-20" *ngIf="LEAVE_HISTORY_DATA.length==0">
        No leave history available
    </div>
    <div style="overflow-y: auto;" class="mt-20">
        <table mat-table [dataSource]="LEAVE_HISTORY_DATA" *ngIf="LEAVE_HISTORY_DATA.length!=0" class="mat-elevation-z8">

            <ng-container matColumnDef="serial">
                <th mat-header-cell *matHeaderCellDef style="width: 80px;"> S.No. </th>
                <td mat-cell *matCellDef="let element;let i=index;">{{i+1}} </td>
            </ng-container>

            <ng-container matColumnDef="day_count">
                <th mat-header-cell *matHeaderCellDef>Total Days </th>
                <td mat-cell *matCellDef="let element"> {{element.day_count}} </td>
            </ng-container>

            <ng-container matColumnDef="startdate">
                <th mat-header-cell *matHeaderCellDef> Start Date </th>
                <td mat-cell *matCellDef="let element"> {{convertDatefmt(element.startdate)}} </td>
            </ng-container>

            <ng-container matColumnDef="enddate">
                <th mat-header-cell *matHeaderCellDef> End Date </th>
                <td mat-cell *matCellDef="let element"> {{convertDatefmt(element.enddate)}} </td>
            </ng-container>

            <ng-container matColumnDef="leave_type">
                <th mat-header-cell *matHeaderCellDef>Type</th>
                <td mat-cell *matCellDef="let element">
                    {{element.leave_type_name == 'Paid' ? 'General' : element.leave_type_name}} </td>
            </ng-container>

            <ng-container matColumnDef="leavestatus">
                <th mat-header-cell *matHeaderCellDef>Leave Status</th>
                <td mat-cell *matCellDef="let element">
                    {{element.req_status}} </td>
            </ng-container>

            <ng-container matColumnDef="correctionstatus">
                <th mat-header-cell *matHeaderCellDef>Correction Status</th>
                <td mat-cell *matCellDef="let element">
                    {{element.discrepancy_status == null ? '--' : element.discrepancy_status}} </td>
            </ng-container>



            <ng-container matColumnDef="view">
                <th mat-header-cell *matHeaderCellDef> Action</th>
                <td mat-cell *matCellDef="let element;let i = index">
                    <div class="flex middle-xs start-xs">
                        <app-button theme="blue-lite" size="extra-small" title="View Details" type="button" style="border: none;background-color: transparent;" (click)="leaveDetailsRequestId={request_id:element.id,get_discrepancy:true}; showAppliedLeaveDialog.open()"> View
                        </app-button>
                        <app-button theme="danger" size="extra-small" *ngIf="!element.discrepancy_raised" type="button" class="ml-5" style="border: none;background-color:transparent;"
                            (click)="onClickRaiseDiscrepancy($event,element)">
                            Correction
                        </app-button>
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="historyLeaveColumns sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: historyLeaveColumns; "></tr>
        </table>
    </div>
</div>

<app-modal-popup (close)="applyFormSubmitted = false" #applyLeaveDialog [w]="'50%'" [maxH]="'90%'" h="auto">
    <div head>
        Apply Leave
    </div>
    <form [formGroup]="applyForm" #f="ngForm">
        <div>
            <div style="max-width: 300px;">
                <mat-form-field>
                    <mat-label>Type</mat-label>
                    <mat-select formControlName="type">
                        <ng-container *ngFor="let type of leaveTypes">
                            <mat-option [value]="type">
                                {{type.name == 'Paid' ? 'General': type.name}}
                            </mat-option>
                        </ng-container>
                    </mat-select>
                    <mat-error class="fs-14" [@slideAnimation]="(applyForm.controls.type.touched || applyFormSubmitted) && applyForm.controls.type.hasError('required') ? 'open': 'close'">
                        Please Select Type
                    </mat-error>
                </mat-form-field>
            </div>

            <div [@slideAnimation]="(!!(applyForm.controls.type.value )) ? 'open' : 'close'">
                <div class="mb-20">
                    <mat-radio-group (change)="onCategoryChanged($event)" class="pb-10 example-radio-group secondary" formControlName="category">
                        <mat-radio-button [disabled]="disableFirst2Categories && category != 'Multiple Days'" class="example-radio-button mr-20" *ngFor="let category of leaveCategories" [value]="category">
                            {{category}}
                        </mat-radio-button>
                        <mat-error class="fs-14 mt-5" [@slideAnimation]="(applyForm.controls.category.touched || applyFormSubmitted) && applyForm.controls.category.hasError('required') ? 'open': 'close'">
                            Please select no of leaves category.
                        </mat-error>
                    </mat-radio-group>
                </div>
            </div>

            <div class="mb-15 mt-20" *ngIf="applyForm.controls.category.value == 'Half Day'">
                <mat-radio-group class="pb-10 example-radio-group secondary" formControlName="half">
                    <mat-radio-button class="example-radio-button mr-20" [value]="half" *ngFor="let half of leaveHours">
                        {{half | titlecase}} Half
                    </mat-radio-button>
                    <mat-error class="fs-14 mt-5" [@slideAnimation]="(applyForm.controls.half.touched || applyFormSubmitted) && applyForm.controls.half.hasError('required') ? 'open': 'close'">
                        Please Select Which half
                    </mat-error>
                </mat-radio-group>
            </div>

            <div [@slideAnimation]="(!!(applyForm.controls.category.value && applyForm.controls.type.value)) ? 'open' : 'close'">
                <div class="mb-15 mt-20">
                    <div class="row">
                        <div class="col-md-6 ">
                            <div class="bg-box">
                                <mat-form-field color="accent">
                                    <mat-label>
                                        {{applyForm.controls.category.value == 'Multiple Days' ? 'Select start date':'Select date'}}
                                    </mat-label>
                                    <input (focus)="refPicker1.open()" formControlName="startDate" [matDatepickerFilter]="datePickerLeaveApplcn.dataPickerFilter()" matInput [matDatepicker]="refPicker1" (dateInput)="onChangeStartDate($event)" readonly>
                                    <mat-datepicker-toggle matSuffix [for]="refPicker1" style="font-size: 22px;">
                                        <mat-icon matDatepickerToggleIcon style="font-size: 22px;">date_range</mat-icon>
                                    </mat-datepicker-toggle>
                                    <mat-datepicker (opened)="onOpenStartDateDatePicker()" [dateClass]="datePickerLeaveApplcn.dateClass()" [startAt]="datePickerLeaveApplcn.startAtStartDate" #refPicker1></mat-datepicker>
                                </mat-form-field>
                                <div *ngIf="applyForm.controls.category.value == 'Multiple Days' &&  applyForm.controls.type.value.name=='Paid'">
                                    <mat-checkbox class="example-margin" [value]="'SECOND'" [disabled]="applyForm.controls.startDateSecondHalf.disabled" formControlName="startDateSecondHalf">
                                        Second Half
                                    </mat-checkbox>
                                </div>
                                <mat-error class="fs-14 mt-5" [@slideAnimation]="(applyForm.controls.startDate.touched || applyFormSubmitted) && applyForm.controls.startDate.hasError('required') ? 'open': 'close'">
                                    Please Select date
                                </mat-error>
                            </div>
                        </div>
                        <div class="col-md-6 " *ngIf="applyForm.controls.category.value == 'Multiple Days'">
                            <div class="bg-box">
                                <mat-form-field color="accent">
                                    <mat-label>Select end date</mat-label>
                                    <input (focus)="refPicker2.open()" formControlName="endDate" [matDatepickerFilter]="datePickerLeaveApplcn.dataPickerFilter('end')" matInput [matDatepicker]="refPicker2" [value]="selectedEndDate" readonly>
                                    <mat-datepicker-toggle style="font-size: 22px;" matSuffix [for]="refPicker2">
                                        <mat-icon matDatepickerToggleIcon style="font-size: 22px;">date_range</mat-icon>
                                    </mat-datepicker-toggle>
                                    <mat-datepicker (opened)="onOpenEndDateDatePicker()" [dateClass]="datePickerLeaveApplcn.dateClass('end')" [startAt]="datePickerLeaveApplcn.startAtendDate" #refPicker2 color="primary"></mat-datepicker>
                                </mat-form-field>
                                <div *ngIf="applyForm.controls.type.value.name=='Paid'">
                                    <mat-checkbox [disabled]="applyForm.controls.endDateFirstHalf.disabled" class="example-margin" [value]="'FIRST'" formControlName="endDateFirstHalf">First Half
                                    </mat-checkbox>
                                </div>
                                <mat-error class="fs-14 mt-5" [@slideAnimation]="(applyForm.controls.endDate.touched || applyFormSubmitted) && applyForm.controls.endDate.hasError('required') && selectedEndDate==undefined ? 'open': 'close'">
                                    Please Select date
                                </mat-error>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mb-15  " [@slideAnimation]="applyForm.controls.type.value && applyForm.controls.type.value.name == 'Marriage' ? 'open': 'close'">
                <mat-form-field class="full-width fg-1 file">
                    <app-file [accept]="{browse:'.jpeg, .jpg, image/jpeg', drop:['.jpeg','.jpg','image/jpeg']}" [folderUpload]="false" formControlName="invitationUpload" [multiple]="true" pH="Drop or browse marriage invitation to upload" idd="upload-marriage-invitations"></app-file>
                    <!-- {{applyForm.controls.invitationUpload.touched}} {{applyForm.controls.invitationUpload.hasError('unAcceptedFile')}} -->
                    <mat-error class="fs-14" *ngIf="(applyForm.controls.invitationUpload.touched || applyFormSubmitted) && applyForm.controls.invitationUpload.hasError('required')">
                        This field is required
                    </mat-error>
                    <mat-error class="fs-14" *ngIf="applyForm.controls.invitationUpload.touched && applyForm.controls.invitationUpload.hasError('unAcceptedFile')">
                        Only jpg, jpeg format files allowed
                    </mat-error>
                </mat-form-field>
            </div>
            <div style="max-width: 300px;" [@slideAnimation]="applyForm.controls.type.value?.name == 'Paid' ? 'open': 'close'">
                <mat-form-field>
                    <mat-label>Leave Reason (Optional)</mat-label>
                    <mat-select formControlName="reason">
                        <mat-option *ngFor="let reason of leaveReasons" [value]="reason">
                            {{reason}}
                        </mat-option>
                    </mat-select>

                    <mat-error class="fs-14" [@slideAnimation]="(applyForm.controls.reason.touched || applyFormSubmitted) && applyForm.controls.reason.hasError('required') ? 'open': 'close'">
                        Please Select Type
                    </mat-error>
                </mat-form-field>
            </div>

            <div style=" grid-column: 1/span 2;">
                <textarea formControlName="comment" placeholder="Purpose of leave" class="leave__comment"></textarea>
                <mat-error [@slideAnimation]="(applyForm.controls.comment.touched || applyFormSubmitted) && applyForm.controls.comment.hasError('required') ? 'open': 'close'">
                    Please Enter Purpose of leave
                </mat-error>
            </div>

            <div class="bg-box mt-15 mb-15" *ngIf="applyForm.controls.type.value?.name !== undefined && applyForm.controls.type.value?.name !== '' &&  applyForm.controls.type.value != null">
                <ng-container *ngIf="applyForm.controls.type.value?.name == 'Paid'">
                    <span>Current leave balance: {{currentBalance}}</span> <br>
                    <span>Selected leave day(s): {{selectedCount}}</span> <br>
                    <span>Updated leave balance: {{currentBalance - selectedCount}}</span>
                </ng-container>
                <ng-container *ngIf="applyForm.controls.type.value?.name == 'Marriage'|| applyForm.controls.type.value?.name == 'Maternity'|| applyForm.controls.type.value?.name == 'Paternity'">
                    <span>Day count : {{selectedCount}}</span>
                </ng-container>
            </div>

        </div>

        <div style="text-align: center;">
            <div style="display: inline-block;padding: 10px;">
                <app-button size='small' theme="danger" type="button" w="130" (click)="closeApplyForm()">Cancel</app-button>
            </div>
            <div style="display: inline-block;padding: 10px;">
                <app-button size='small' theme="blue-lite" type="submit" w="130" (click)="getTimesheetDiscrepancy()">Submit
                </app-button>
            </div>
        </div>
    </form>
</app-modal-popup>

<app-leave-details #showAppliedLeaveDialog [requestId]="leaveDetailsRequestId" type="self"></app-leave-details>

<app-modal-popup (close)="applyFormSubmitted = false" #timesheetDiscrepancyDialog [w]="'50%'" [maxH]="'90%'" h="auto">
    <div head>
        Submitted timesheet
    </div>
    <div>
        <p style="color: red;"> <b>NOTE:</b> Timesheet had been already submitted. Hours for followings will be changed on submission the request</p>
        <table mat-table [dataSource]="TIMESHEET_DISCREPANCY_DATA" *ngIf="TIMESHEET_DISCREPANCY_DATA.length!=0" class="mat-elevation-z8">

            <ng-container matColumnDef="serial">
                <th mat-header-cell *matHeaderCellDef style="width: 80px;"> S No </th>
                <td mat-cell *matCellDef="let element;let i=index;">{{i+1}} </td>
            </ng-container>

            <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let element"> {{element.work_date}} </td>
            </ng-container>

            <ng-container matColumnDef="project">
                <th mat-header-cell *matHeaderCellDef>Project </th>
                <td mat-cell *matCellDef="let element"> {{element.project_name}} </td>
            </ng-container>

            <ng-container matColumnDef="posted_hours">
                <th mat-header-cell *matHeaderCellDef> Posted Hours </th>
                <td mat-cell *matCellDef="let element"> {{element.work_minutes}} </td>
            </ng-container>

            <ng-container matColumnDef="modified_hours">
                <th mat-header-cell *matHeaderCellDef> Modified Hours </th>
                <td mat-cell *matCellDef="let element"> {{element.modified_work_minutes}} </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="timesheetDiscrepancyColumns sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: timesheetDiscrepancyColumns; "></tr>
        </table>
        <app-button style="float:right" size='small' theme="blue-lite" type="submit" w="130" (click)="onSubmitApplyForm()">Proceed
        </app-button>
    </div>
</app-modal-popup>